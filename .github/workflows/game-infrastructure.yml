name: Game Infrastructure

on:
  push:
    branches: [ main ]
    paths:
      - ".github/workflows/game-infrastructure.yml"
      - "docker/**"

env:
  CARGO_TERM_COLOR: always

jobs:
  docker:
    runs-on: ubuntu-latest
    environment: heartlabs.tech
    steps:
    - uses: actions/checkout@v2
    - name: copy docker-compose files via ssh
      uses: appleboy/scp-action@master
      with:
        host: v2202204174441188151.happysrv.de
        username: ${{ secrets.DEPLOY_USER }}
        password: ${{ secrets.DEPLOY_USER_PASSWORD }}
        source: "docker/*"
        target: "/home/server/docker"
        strip_components: 1
    - name: restart docker compose
      uses: appleboy/ssh-action@v0.1.10
      with:
        host: v2202204174441188151.happysrv.de
        username: ${{ secrets.DEPLOY_USER }}
        password: ${{ secrets.DEPLOY_USER_PASSWORD }}
        script: cd /home/server/docker && docker compose pull && docker compose up -d --remove-orphans # --force-recreate
    
